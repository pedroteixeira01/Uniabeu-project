<?phpsession_start();require_once('classes/usuario.php');require_once('classes/util.php');function Processo($Processo) {    /* Switch processos */    switch ($Processo) {        /* login de identificação */        case 'login':            $util = new Util();            $usuario = new Usuario();            if (@$_POST['ok'] == 'true') {                $senha = base64_encode($_POST['senha']);                $sql = "select * from usuario u inner join perfil p on(u.idperfil=p.idperfil) where u.email='" . $_POST['email'] . "' and u.senha='" . $senha . "'";                $usuario->consultar($sql);                $rs = $usuario->Result;                $linha = $usuario->Linha;                if ($linha > 0) {                    $_SESSION['idusuario'] = $rs[0]['idusuario'];                    $_SESSION['idperfil'] = $rs[0]['idperfil'];                    $_SESSION['perfil'] = $rs[0]['descricao'];                    $_SESSION['nome'] = $rs[0]['nome'];                    $_SESSION['email'] = $rs[0]['email'];                    if ($_SESSION['idperfil'] == 1) {                        $pg = base64_encode("visao/principal/inicio.php");                        $form = ("Painel de Controle / Principal");                        $d = "default.php?pg=";                        $util->redirecionamentopage($d . $pg . "&form=" . $form);                    }                } else {                    $util->msgbox("Login ou senha errado!");                }            }            break;        case 'loginInscricao':            $util = new Util();            $usuario = new Usuario();            if (@$_POST['ok'] == 'true') {                $senha = base64_encode($_POST['senha']);                $sql = "select * from usuario u inner join perfil p on(u.idperfil=p.idperfil) where u.email='" . $_POST['email'] . "' and u.senha='" . $senha . "'";                $usuario->consultar($sql);                $rs = $usuario->Result;                $linha = $usuario->Linha;                if ($linha > 0) {                    $_SESSION['idusuario'] = $rs[0]['idusuario'];                    $_SESSION['idperfil'] = $rs[0]['idperfil'];                    $_SESSION['perfil'] = $rs[0]['descricao'];                    $_SESSION['nome'] = $rs[0]['nome'];                    $_SESSION['sobrenome'] = $rs[0]['sobrenome'];                    $_SESSION['idpais'] = $rs[0]['idpais'];                    $_SESSION['idcolegio'] = $rs[0]['idcolegio'];                    $_SESSION['idcolegio'] = base64_decode($rs[0]['senha']);                    $_SESSION['email'] = $rs[0]['email'];                    if ($_SESSION['idperfil'] == 2) {                        $d = "default.php?pg=";                        $util->redirecionamentopage('inscricao.php');                    }                } else {                    $util->msgbox("E-mail ou senha errada!");                }            }            break;        case 'loginInscricaoEs':            $util = new Util();            $usuario = new Usuario();            if (@$_POST['ok'] == 'true') {                $senha = base64_encode($_POST['senha']);                $sql = "select * from usuario u inner join perfil p on(u.idperfil=p.idperfil) where u.email='" . $_POST['email'] . "' and u.senha='" . $senha . "'";                $usuario->consultar($sql);                $rs = $usuario->Result;                $linha = $usuario->Linha;                if ($linha > 0) {                    $_SESSION['idusuario'] = $rs[0]['idusuario'];                    $_SESSION['idperfil'] = $rs[0]['idperfil'];                    $_SESSION['perfil'] = $rs[0]['descricao'];                    $_SESSION['nome'] = $rs[0]['nome'];                    $_SESSION['sobrenome'] = $rs[0]['sobrenome'];                    $_SESSION['idpais'] = $rs[0]['idpais'];                    $_SESSION['idcolegio'] = $rs[0]['idcolegio'];                    $_SESSION['email'] = $rs[0]['email'];                    if ($_SESSION['idperfil'] == 2) {                        if (@$_POST['pgIdioma'] == 'es') {                            $util->redirecionamentopage('inscricao_es.php');                        } else {                            $util->redirecionamentopage('inscricao.php');                        }                    }                } else {                    if (@$_POST['pgIdioma'] == 'es') {                        $util->msgbox("correo electrónico o contraseña incorrecta");                    } else {                        $util->msgbox("E-mail ou senha incorreta");                    }                }            }            break;        case 'esqueceuSenha':            /* Atributos Globais */            $usuario = new usuario();            $util = new Util();            $ocorrencias = new Ocorrencias();            if (@$_POST['ok'] == 'true') {                $sql = "select u.idusuario as idusuario,p.nome as nome, p.cpf as cpf, concat(concat(substring(p.nome,1,2), u.idusuario),'89e122') as senha, perfil.descricao as perfil, u.idsituacao as idsituacao from usuario u inner join pessoa p  on(u.idusuario=p.idusuario) inner join perfil on(u.idperfil=perfil.idperfil) where p.email='" . trim($_POST['email']) . "' and u.idsituacao=1";                $usuario->consultar($sql);                $rs = $usuario->Result;                $linha = $usuario->Linha;                if ($linha > 0) {                    $idusuario = $rs[0]['idusuario'];                    $nome = $rs[0]['nome'];                    $login = $rs[0]['cpf'];                    $senha = $rs[0]['senha'];                    $senha = $util->gerarsenha($senha);                    $perfil = $rs[0]['perfil'];                    $idsituacao = $rs[0]['idsituacao'];                    //LIBERADO                    if ($idsituacao == 1) {                        try {                            $usuario->consultar("BEGIN");                            $util->enviarEmailSenha($login, $nome, $senha, trim($_POST['email']), $perfil);                            $descricao = "Recupera&ccedil;&atilde;o de senha do Sr(a). <b>.$login.' - '.$nome .</b> \n";                            $funcionalidade = "Esqueceu senha";                            $data_hora = date('Y-m-d h:i:s');                            //$ocorrencias->incluir($idusuario, utf8_decode($descricao), utf8_decode($funcionalidade));                            exit;                            $util->MsgboxSimNaoNovoCad("Os dados de autenticação de acesso do sysalumni foram enviados para o seguinte e-mail :" . $_POST['email'], "esqueceu_senha.php");                            $usuario->consultar("COMMIT");                        } catch (Exception $ex) {                            $usuario->consultar("ROLLBACK");                            $util->msgbox("Entre em contato com o administrador!");                        }                    }                    //AGUARDANDO LIBERAÇÃO                    if ($idsituacao == 3) {                        $util->msgbox("Por gentileza aguarde o tempo de liberação de acesso estimado ou entre em contato conosco (contato@alumnisys.org), caso o tempo de resposta tenha esgotado.");                    }                    //Acesso negado                    if ($idsituacao == 2) {                        $util->msgbox("Lamentamos informar, mas seus dados não foram encontrados em nosso registro para que possamos liberar seu acesso. Em caso de dúvidas ou equívoco, por gentileza entre em contato conosco (contato@alumnisys.org)");                    }                } else {                    $util->msgbox("O e-mail informado não foi encontrado, por favor entre em contato conosco (contato@alumnisys.org)!");                }            }            break;        case 'logoff':            $util = new Util();            break;        case 'inicio':            $util = new Util();            $usuario = new Usuario();            global $linha;            global $rs;            global $total;            $usuario->consultar("select count(idinscricao) as total from inscricao where situacao='INSCRITO'");            $rs = $usuario->Result;            $linha = $usuario->Linha;            $total = $rs[0]['total'];            break;    }}?>